---
title: '2020 SPI Update: What''s Changed?'
author: "SPI Team"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    fig_width: 9
    fig_height: 6
abstract: 'In September 2021, the second vintage of the SPI data was released.  This document provides an overview of the major changes to the scores compared to the intial data release in March 2021.  Two types of changes occured.  First, SPI scores for 2016 to 2019 have been updated to include any new information that has been made available.  Second, SPI scores for the calendar year 2020 have been released.  This document discusses both changes.'
bibliography: ./bibliography.bib
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9.5, fig.height = 6, fig.path = "plots/", dev = c("png"), dpi=500)


library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
# library(wbggeo)
# library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
#set directories
dir <- here()

raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")

#weights (either unity (1) or population (2))
wgt <- 1

```


```{r themes}

#ggplot theme
theme_spi <- function () { 
    theme_bw() %+replace%
    theme(
      plot.caption = element_text(hjust = 0),
      plot.title=element_blank() #remove all titles from plots (sometimes we may need to bring title outside plot)
    )
}


```

```{r data}

spi_index_df<-read_csv(paste0(output_dir,"/SPI_index.csv"))

```


```{r programs, include=FALSE}


#For mapping the result
# quality = "high"
# maps <- wbgmaps::wbgmaps[[quality]]
#load world bank map data
load(paste0(raw_dir, '/misc/maps.Rdata'))
standard_crop_wintri <- function() {
  l <- list(
    left=-12000000, right=16396891,
    top=9400000, bottom=-6500000
  )
  l$xlim <- c(l$left, l$right)
  l$ylim <- c(l$bottom, l$top)
  l
}


country_metadata <- wbstats::wbcountries()




spi_mapper  <- function(data, indicator, title) {
  
 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     


  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top Quintile",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.3,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Score',
      values=col_pal,
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)
}

spi_region_charts  <- function(data, indicator, title) {
  
    map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))  
    
    
    
    
  #add histogram by region 
  region_SPI_df <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    arrange(-`SPI Score`) 
  
  region_order <- c("Sub-Saharan Africa " ,
                    "South Asia",
                    "North America",
                    "Middle East & North Africa",
                    "Latin America & Caribbean ",
                    "Europe & Central Asia", 
                    "East Asia & Pacific"
                           )

  region_SPI_df <- region_SPI_df %>%
    mutate(region=factor(region, levels=region_order))
  
   p2 <-  ggplot(region_SPI_df, aes(x=`SPI Score`, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')


  # p2_alt <- map_df %>%
  #   ungroup() %>%
  #   filter(region!='Aggregates') %>%
  #   mutate(`SPI Score`=(data_available),
  #          Label = paste(round(`SPI Score`,0))) %>%
  #   ggplot(aes(x=`SPI Score`, y=region, color=region)) +
  #     geom_point() +
  #     geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
  #     labs(
  #     title=str_wrap(paste(title, 'By Country', sep=" - "),100),
  #     caption = 'Source: World Bank. Statistical Performance Indicators.',
  #     subtitle= 'Based on data for 2020 or the latest year available'
  #     ) +
  #     expand_limits(x=c(0,100)) +
  #     theme_spi() +
  #     theme(legend.position = 'top')  
  

  print(p2)
  


    
}

spi_income_charts  <- function(data, indicator, title) {
  
    map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))  
    
    
    
    


  # p2_alt <- map_df %>%
  #   ungroup() %>%
  #   filter(region!='Aggregates') %>%
  #   mutate(`SPI Score`=(data_available),
  #          Label = paste(round(`SPI Score`,0))) %>%
  #   ggplot(aes(x=`SPI Score`, y=region, color=region)) +
  #     geom_point() +
  #     geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
  #     labs(
  #     title=str_wrap(paste(title, 'By Country', sep=" - "),100),
  #     caption = 'Source: World Bank. Statistical Performance Indicators.',
  #     subtitle= 'Based on data for 2020 or the latest year available'
  #     ) +
  #     expand_limits(x=c(0,100)) +
  #     theme_spi() +
  #     theme(legend.position = 'top')  
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")

    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
    


  print(p3)


}

spi_time_charts  <- function(data, indicator, title) {
  

    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by(income, date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ungroup() %>%
    ggplot(aes(y=`SPI Score`, x=date, color=income)) +
      geom_point() +
      geom_line() +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.'
      ) +
      expand_limits(y=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
  

            
      


  print(p4)
    
}

spi_country_charts  <- function(data, indicator, title) {
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    filter(region!="Aggregates") %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top Quintile",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  

  region_order <- c("Sub-Saharan Africa " ,
                    "South Asia",
                    "North America",
                    "Middle East & North Africa",
                    "Latin America & Caribbean ",
                    "Europe & Central Asia", 
                    "East Asia & Pacific"
                           )
  
  p2_alt <- SPI_map %>%
    ungroup() %>%
    mutate(region=factor(region, levels=region_order)) %>%
    ggplot(aes(x=data_available, y=region, color=spi_groups)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      xlab('Score') +
      expand_limits(x=c(0,100)) +
      scale_color_manual(
        name='SPI Score',
        values=col_pal,
        na.value='grey'
      ) +
      theme_spi() +
      theme(legend.position = 'top') 
   
p2_alt

}


spi_maturity_table <- function(data, indicators, reference_year) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      select(country, iso3c, date, income, region, all_of(indicators), SPI.INDEX) 
    
    
    spi_groups_quantiles <- quantile(df_overall$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
    
    df_overall <- df_overall %>%
      mutate(spi_groups=case_when(
        between(SPI.INDEX, spi_groups_quantiles[4],100) ~ "Top Quintile",
        between(SPI.INDEX, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
        between(SPI.INDEX, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
        between(SPI.INDEX, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
        between(SPI.INDEX, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      )) %>%
      mutate(spi_groups=factor(spi_groups, 
                               levels=c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(spi_groups) %>%
      filter(!is.na(spi_groups)) %>%
      select(spi_groups, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(spi_groups='Global') %>%
      group_by(spi_groups) %>%
      select(spi_groups, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-spi_groups)))
    colnames(sumstats_df) = sumstats_df_long$spi_groups 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Label, c("Top Quintile","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" ))

      sumstats_df
 

}


spi_group_table <- function(data, indicators, reference_year, group) {

      df_overall <- get(data) %>%
      filter(date==as.numeric(reference_year)) %>% 
      left_join(country_metadata) %>%
      select(country, iso3c, date, income, region, lending, all_of(indicators), SPI.INDEX) %>%
      rename(group=!! group)
    
    
    
    #produce by income
    sumstats<- df_overall %>%
      group_by(group) %>%
      filter(!is.na(group)) %>%
      select(group, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    #produce global number
    sumstats_gl<- df_overall %>%
      mutate(group='Global') %>%
      group_by(group) %>%
      select(group, all_of(indicators)) %>%
      summarise_all(~round(mean(., na.rm=T),1)) 
    
    
    #transpose data
    sumstats_df_long <-sumstats 
    
    sumstats_df <- as.data.frame(t(sumstats_df_long %>% select(-group)))
    colnames(sumstats_df) = sumstats_df_long$group 
    
    
    sumstats_df <- sumstats_df %>%
      rownames_to_column() %>%
      rename(series=rowname)
    
    
    #create labels df
    metadata_tab2_overall <- metadata_full %>% 
      janitor::clean_names() %>%
      transmute(series=source_id, 
                indicator_name=source_name)
    
    
    #add variable label
    sumstats_df <- sumstats_df %>%
      left_join(metadata_tab2_overall) %>%
      rename(Series=series,
             Label=indicator_name) %>%
      mutate(Label=if_else(is.na(Label),Series,Label)) %>%
      select(Label, everything()) %>%
      select(-Series)

      sumstats_df
 

}

lending_charts <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending, color=lending)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            title= element_text(size = 20),
            axis.title.y=element_blank(),
            text = element_text(size = 14)) 
   
p2_alt3 
  
 
}

lending_chart_aggregate <- function(data, indicator, title) { 


 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  

  p2_alt3 <- map_df %>%
    group_by(lending) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending, fill=lending)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            # title= element_text(size = 20),
            # axis.title.y=element_blank(),
            # text = element_text(size = 14)) 
   
p2_alt3 
  
 
}



fcs_charts <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            #text=element_text(size=14)) 
   
p2_alt2 
  
 
}


fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  

 indicator<-indicator

  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  

  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")

  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = str_wrap('Source: World Bank. Statistical Performance Indicators. Non-FCS countries include all countries not classified as FCS.  This includes high income countries.',70),
      subtitle= 'Based on data for 2020 or the latest year available'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top')
            #text=element_text(size=14)) 
  
  
  
p2_alt2 
  
 
}


#define function to pull data from UN Stats and return
un_pull <- function(series,start, end) {
  # jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&timePeriodStart=',start,'&timePeriodEnd=',end,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%
      jsonlite::fromJSON(paste('https://unstats.un.org/SDGAPI/v1/sdg/Series/Data?seriesCode=',series,'&pageSize=10000',sep=""), flatten = TRUE)$data %>%

    as_tibble() %>%
    mutate(date=timePeriodStart) %>%
    right_join(iso3c)
    
}  

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% 
    add_footer_lines(values = "Source: World Bank. Statistical Performance Indicators."                 ) %>%
    autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

#add equations to plots
eq_plot_txt <- function(data) {
  eq <- lm_robust(SPI.INDEX ~ value, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  sprintf("y = %.3f + %.3f x, R<sup>2</sup> = %.3f <br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

}

```

## Minor Methodological Changes

For the wb_ial data measure, small countries are defined as having a surface area of 1,500 sq km. or less and are exlcuded from the calculation. In ODIN 2020/21, this includes Andorra, Anguilla, Antigua and Barbuda, Bahrain, Dominica, Hong Kong, Macao, Maldives, Malta, Marshall Islands, Micronesia, Monaco, Palau, Sao Tome and Principe, San Marino, Seychelles, Singapore, St. Kitts and Nevis, St. Lucia, St. Vincent and the Grenadines, Tonga, and Liechtenstein.  For these countries, because they have no data available at the 1st admin level from ODIN, they are given the ODIN overall coverage score, in place of the availability of data at the 1st admin level score.

## Country Changes because of changes in SPI vintanges

The first set of changes that are considered are changes to the 2016 to 2019 SPI scores due to the vintage of the raw information used to produce the scores. When new information about a country is available, a country's SPI scores can change.  For instance, it may be the case that a country completes a survey in 2018, but this survey is only found by the SPI team in 2021 either because of delays in releasing the information or because the SPI team did not locate the survey previously. A second example would be if a country made more data available tracking progress for the Sustainable Development Goals (SDGs).  In these cases, the country is retrospectively given credit for producing this information.  


```{r changesvint}
#create a dataframe for the 2019 SPI to calculate changes since 2019

spi_index_2019_v2 <- spi_index_df %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX))

spi_index_2019_v1 <- read_csv(paste0(raw_dir,"/misc/SPI_index_vintage_mar2021.csv")) %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX)) %>%
  mutate(SPI.INDEX.2019.v1=SPI.INDEX) %>%
  select(iso3c, country, region, SPI.INDEX.2019.v1)

spi_vintage_changes <- spi_index_2019_v2 %>%
  mutate(SPI.INDEX.2019.v2=SPI.INDEX) %>%
  select(iso3c, country,region, SPI.INDEX.2019.v2) %>%
  left_join(spi_index_2019_v1)


#correlation
corr_v1_v2 <- cor(spi_vintage_changes$SPI.INDEX.2019.v2,spi_vintage_changes$SPI.INDEX.2019.v1, use='pairwise.complete.obs')


```

In order to assess how much change exists in the index values are over time, comparisons have been made between the index values in 2019 for the March 2021 and September 2021 vintages. Overall, the SPI overall score is quite stable over time. The correlation between the March 2021 vintage and Sept 2021 vintage value is `r round(corr_v1_v2,2)`.

*Figure 1.1: Scatterplot of 2019 SPI overall score from Sept 2021 release  & 2019 SPI overall score from March 2021 release*
```{r changesplotvint}

ggplot(spi_vintage_changes, aes(x=SPI.INDEX.2019.v1, y=SPI.INDEX.2019.v2, color=region)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  geom_segment(aes(x=10,xend=100, y=10,yend=100), color='grey') +
  expand_limits(x=c(10,100),y=c(10,100)) +
  theme_spi() +
  labs(
    title='Scatterplot of Sept 2021 vintage and March 2021 vintage 2019 SPI overall score',
    caption = 'Solid grey line represents the 45 degree line.  Blue line represents line of best fit (regression line) with a 95% confidence interval shown in a shaded line.'
  ) +
  ylab('Sept 2021 vintage') +
  xlab('March 2021 vintage') +
  theme(legend.position = 'bottom') +
    stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='blue',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
  guides(
    size="none"
  )


```



```{r top_bottom_changes_v}

top_changes <- spi_vintage_changes %>%
  mutate(changes=SPI.INDEX.2019.v2-SPI.INDEX.2019.v1) %>%
  arrange(-abs(changes)) %>%
  select(country,SPI.INDEX.2019.v2,SPI.INDEX.2019.v1, changes) %>%
  mutate(across(c('SPI.INDEX.2019.v2','SPI.INDEX.2019.v1', 'changes'),round,1))

top_mover <- as.character(top_changes[1,1])
top_mover_change <- as.numeric(top_changes[1,4])
```


While the scores were relatively stable over time, some countries did see large improvements in their score for 2019 between the two vintages in March and Septebmer 2021. The country that changed most on the index from 2019 to 2020 was `r top_mover`. `r top_mover` changed by `r top_mover_change` points out of 100. The table below shows the changes in the SPI overall score for the top 10 largest changers


*Table 7.2: Top 10 Countries with Largest Changes from 2019-2020.*
```{r topbottomchangestabv}
top_changes_tab <- flextable(head(top_changes,10)) %>%
  # add_header_lines('Top 10 Countries with Largest Changes from 2019-2020.') %>%
  set_header_labels(values=list(
                       country="Country",
                       SPI.INDEX.2019.v2="SPI Overall Score Vintage Sept 2021",
                       SPI.INDEX.2019.v1="SPI Overall Score  Vintage March 2021",
                       changes="Difference"
                                   )) 

FitFlextableToPage(top_changes_tab) %>%
  width(width=1.2) %>%
  align( align = "left", part = "body")
```
## Country Changes in the Index between 2019 and 2020



```{r changes}
#create a dataframe for the 2019 SPI to calculate changes since 2019

spi_index_2020 <- spi_index_df %>%
  filter(date==2020) %>%
  filter(!is.na(SPI.INDEX))

spi_index_2019 <- spi_index_df %>%
  filter(date==2019) %>%
  filter(!is.na(SPI.INDEX)) %>%
  mutate(SPI.INDEX.2019=SPI.INDEX) %>%
  select(iso3c, country, region, SPI.INDEX.2019)

spi_changes <- spi_index_2020 %>%
  mutate(SPI.INDEX.2020=SPI.INDEX) %>%
  select(iso3c, country,region, SPI.INDEX.2020) %>%
  left_join(spi_index_2019)


#correlation
corr_2020_2019 <- cor(spi_changes$SPI.INDEX.2020,spi_changes$SPI.INDEX.2019, use='pairwise.complete.obs')


```

In order to assess how much change exists in the index values are over time, comparisons have been made between the index values in 2019 and the 2020 values. Overall, the SPI overall score is quite stable over time. The correlation between the 2019 value and the 2020 value is `r round(corr_2020_2019,2)`.

*Figure 7.4: Scatterplot of 2020 SPI overall score  & 2019 SPI overall score*
```{r changesplot}

ggplot(spi_changes, aes(x=SPI.INDEX.2019, y=SPI.INDEX.2020, color=region)) +
  geom_text(aes(label=iso3c)) +
  geom_smooth(method='lm', color='blue') +
  geom_segment(aes(x=10,xend=100, y=10,yend=100), color='grey') +
  expand_limits(x=c(10,100),y=c(10,100)) +
  theme_spi() +
  labs(
    title='Scatterplot of 2020 SPI overall score  & 2019 SPI overall score',
    caption = 'Solid grey line represents the 45 degree line.  Blue line represents line of best fit (regression line) with a 95% confidence interval shown in a shaded line.'
  ) +
  ylab('2020 SPI Overall Score') +
  xlab('2019 SPI Overall Score') +
  theme(legend.position = 'bottom') +
    stat_poly_eq(aes(label = paste(stat(eq.label),
                                stat(rr.label), sep = "*\", \"*")), 
                     color='blue',
                     label.x.npc = "right", label.y.npc = 0.1,
                     formula = 'y~x', parse = TRUE, size = 4) +
  guides(
    size="none"
  )


```


```{r top_bottom_changes}

top_changes <- spi_changes %>%
  mutate(changes=SPI.INDEX.2020-SPI.INDEX.2019) %>%
  arrange(-abs(changes)) %>%
  select(country,SPI.INDEX.2020,SPI.INDEX.2019, changes) %>%
  mutate(across(c('SPI.INDEX.2020','SPI.INDEX.2019', 'changes'),round,1))

top_mover <- as.character(top_changes[1,1])
top_mover_change <- as.numeric(top_changes[1,4])
```


While the scores were relatively stable over time, some countries did see large improvements in their score from 2019-2020. The country that improved most on the index from 2019 to 2020 was `r top_mover`. `r top_mover` improved by `r top_mover_change` points out of 100. The table below shows the changes in the SPI overall score for the top 10 largest improvers.


*Table 7.2: Top 10 Countries with Largest Changes from 2019-2020.*
```{r topbottomchangestab}
top_changes_tab <- flextable(head(top_changes,10)) %>%
  # add_header_lines('Top 10 Countries with Largest Changes from 2019-2020.') %>%
  set_header_labels(values=list(
                       country="Country",
                       SPI.INDEX.2020="SPI Overall Score 2020",
                       SPI.INDEX.2019="SPI Overall Score 2019",
                       changes="Difference"
                                   )) 

FitFlextableToPage(top_changes_tab) %>%
  width(width=1.2) %>%
  align( align = "left", part = "body")
```

In the following map, countries that improved by more than 5 points on the 0-100 scale are shown in dark green, countries that improved by between 2 and 5 points in light green, countries that saw decreases between 2 and 5 points in light red, and countries that say decreases of more than 5 points in dark red.  Countries with a change of less than 2 points in either direction are shaded in light blue.

```{r changes_map}

title <- "Changes in SPI Overall Scores between 2019 and 2020."

#create dataset with changes between 2020 and 2019
  map_df <- spi_changes %>%
    select(iso3c, SPI.INDEX.2020, SPI.INDEX.2019) %>%
    right_join(country_metadata)
    
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      SPI.INDEX.2020-SPI.INDEX.2019 > 5 ~ "Improved >5 points",
      between(SPI.INDEX.2020-SPI.INDEX.2019, 2,5) ~ "Improved 2-5 points",
      between(SPI.INDEX.2020-SPI.INDEX.2019, -2,2) ~ "Little Change",
      between(SPI.INDEX.2020-SPI.INDEX.2019, -5,-2) ~ "Dropped 2-5 points",
      SPI.INDEX.2020-SPI.INDEX.2019 < -5 ~ "Dropped >5 points"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Improved >5 points","Improved 2-5 points","Little Change","Dropped 2-5 points","Dropped >5 points" )))  
  
  #set color pallete
  col_pal <- c("#0B3954","#087E8B","#BFD7EA","#FF5A5F","#C81D25")  
  names(col_pal) <- c("Improved >5 points","Improved 2-5 points","Little Change","Dropped 2-5 points","Dropped >5 points")
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.3,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Changes',
      values=col_pal,
      na.value='grey',
      drop=FALSE
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    )
 print(p1)

```




```{r elephant, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=14}

growth_plot <- function(variables, name) {
  


  elephant_df <- spi_index_df %>%
    rename(spi_data=!! variables) %>%
    select(country, iso3c, date, spi_data) %>%
    group_by(country, date) %>%
    mutate(row = row_number()) %>%
    pivot_wider(names_from=date,
                names_prefix='spi_data_',
                values_from=c('spi_data')) %>%
    ungroup() %>%
    mutate(growth=(spi_data_2020-spi_data_2019)) %>%
    filter(!(is.na(spi_data_2020) | is.na(spi_data_2019))) %>%
    mutate(spi_rank=100*rank(spi_data_2019)/length(spi_data_2019),
           spi_bins=case_when( #calculate deciles
             between(spi_rank,0,10) ~ "1st Decile",
             between(spi_rank,10,20) ~ "2nd Decile",
             between(spi_rank,20,30) ~ "3rd Decile",
             between(spi_rank,30,40) ~ "4th Decile",
             between(spi_rank,40,50) ~ "5th Decile",
             between(spi_rank,50,60) ~ "6th Decile",
             between(spi_rank,60,70) ~ "7th Decile",
             between(spi_rank,70,80) ~ "8th Decile",
             between(spi_rank,80,90) ~ "9th Decile",
             between(spi_rank,90,100) ~ "Top Decile"
           )) %>%
    arrange(spi_rank)
  
  #summarise into decile bins
  elephant_df <- elephant_df %>%
    mutate(spi_bins=factor(spi_bins, levels=unique(elephant_df$spi_bins))) %>%
    group_by(spi_bins) %>%
    summarise(growth=mean(growth))
  
  ggplot(elephant_df, aes(x=spi_bins, y=growth, label=paste0(spi_bins,": ",round(growth,1),""))) +
    geom_segment(aes(xend=as.numeric(spi_bins)-0.5,x=as.numeric(spi_bins)+0.5, y=growth, yend=growth)) +
    geom_point() +
    geom_bar(aes(alpha=growth), stat = "identity", fill='#007f5f') +
    ggrepel::geom_text_repel(nudge_y=0.1, size=4,segment.alpha =  0 ) +
    scale_x_discrete() +
    theme_bw() +
    xlab(str_wrap('Decile in 2019',40)) +
    ylab(str_wrap('Change in Score (2019-20)',20)) +
    labs(
      #title=str_wrap("2nd & 3rd deciles have improved most since 2019.",70),
      subtitle=str_wrap('Change in SPI Overall Score from 2019-20 by 2019 decile group',70),
      caption=paste0(name,' scale = 0 - 100 points.')
    ) +
    expand_limits(y=0) +
    scale_alpha_continuous(
      range=c(0.3,1)
    ) +
    expand_limits(y=c(-2,3)) +
  theme(
    axis.title.y = element_text(angle=0, vjust = 0.5),
    text = element_text(size = 14),
    title= element_text(size = 20),
    legend.position = 'none'
  )

}


# growth_plot('SPI.INDEX.PIL1', 'SPI Pillar 1 (Data Use) Score')
# growth_plot('SPI.INDEX.PIL2', 'SPI Pillar 2 (Data Services) Score')
# growth_plot('SPI.INDEX.PIL3', 'SPI Pillar 3 (Data Products) Score')
# growth_plot('SPI.INDEX.PIL4', 'SPI Pillar 4 (Data Sources) Score')
# growth_plot('SPI.INDEX.PIL5', 'SPI Pillar 5 (Data Infrastructure) Score')


```

```{r elplot, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}

growth_plot('SPI.INDEX', 'SPI Overall Score')

```



```{r elephantstacked, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}



  elephant_stacked_df <- spi_index_df %>%
    select(country, iso3c, date, starts_with('SPI.INDEX')) %>%
    group_by(country, date) %>%
    mutate(row = row_number()) %>%
    pivot_wider(names_from=date,
                values_from=starts_with('SPI.INDEX')) %>%
    ungroup() %>%
    mutate(overall_growth=(SPI.INDEX_2020-SPI.INDEX_2019),
           dim1_growth=(SPI.INDEX.PIL1_2020-SPI.INDEX.PIL1_2019),
           dim2_growth=(SPI.INDEX.PIL2_2020-SPI.INDEX.PIL2_2019),
           dim3_growth=(SPI.INDEX.PIL3_2020-SPI.INDEX.PIL3_2019),
           dim4_growth=(SPI.INDEX.PIL4_2020-SPI.INDEX.PIL4_2019),
           dim5_growth=(SPI.INDEX.PIL5_2020-SPI.INDEX.PIL5_2019)
           ) %>%
    filter(!(is.na(SPI.INDEX_2020) | is.na(SPI.INDEX_2019))) %>%
    mutate(spi_rank=100*rank(SPI.INDEX_2019)/length(SPI.INDEX_2019),
           spi_bins=case_when( #calculate deciles
             between(spi_rank,0,10) ~ "1st Decile",
             between(spi_rank,10,20) ~ "2nd Decile",
             between(spi_rank,20,30) ~ "3rd Decile",
             between(spi_rank,30,40) ~ "4th Decile",
             between(spi_rank,40,50) ~ "5th Decile",
             between(spi_rank,50,60) ~ "6th Decile",
             between(spi_rank,60,70) ~ "7th Decile",
             between(spi_rank,70,80) ~ "8th Decile",
             between(spi_rank,80,90) ~ "9th Decile",
             between(spi_rank,90,100) ~ "Top Decile"
           )) %>%
    arrange(spi_rank)
  
  #summarise into decile bins
  elephant_stacked_df <- elephant_stacked_df %>%
    mutate(spi_bins=factor(spi_bins, levels=unique(elephant_stacked_df$spi_bins))) %>%
    group_by(spi_bins) %>%
    summarise(
              D1=mean(dim1_growth),
              D2=mean(dim2_growth),
              D3=mean(dim3_growth),
              D4=mean(dim4_growth),
              D5=mean(dim5_growth)) %>%
    pivot_longer(
      cols=c('D1', 'D2', 'D3', 'D4', 'D5'),
      values_to='growth',
      names_to='pillar'
    ) %>%
    mutate(pillar=case_when(
      pillar=="D1" ~ "Pillar 1: Data Use",
      pillar=="D2" ~ "Pillar 2: Data Services",
      pillar=="D3" ~ "Pillar 3: Data Products",
      pillar=="D4" ~ "Pillar 4: Data Sources",
      pillar=="D5" ~ "Pillar 5: Data Infrastructure"
    )) %>%
    mutate(growth=growth/5) #divide by 5 so that pillar scores sum to overall score.  This puts equal weight on each pillar in the sum
  






```

```{r elplotstacked, echo=FALSE, dpi=250, message=FALSE, warning=FALSE, fig.height=8, fig.width=12}
name <- 'SPI Overall Score'

  ggplot(elephant_stacked_df, aes(x=spi_bins, y=growth, fill=pillar, label=paste0(round(growth,1)))) +
    geom_bar(stat = "identity", position='stack') +
    geom_text(size = 4, position = position_stack(vjust = 0.5)) +
    scale_x_discrete() +
    theme_bw() +
    xlab(str_wrap('Decile in 2019',40)) +
    ylab(str_wrap('Change in Score (2019-20)',20)) +
    labs(
      #title=str_wrap("Countries in 2nd and 3rd deciles have grown most since 2019.",70),
      subtitle=str_wrap('Change in SPI Overall Score from 2019-20 by 2019 decile group',70),
      caption=paste0(name,' scale = 0 - 100 points.')
    ) +
    expand_limits(y=c(-2,3)) +
  theme(
    axis.title.y = element_text(angle=0, vjust = 0.5),
    text = element_text(size = 14),
    title= element_text(size = 20),
    legend.position = 'bottom'
  ) +
    guides(fill=guide_legend(nrow=2,byrow=TRUE))

```
# Appendix

## Country SPI overall scores

Below, the full list of countries by their SPI overall score in 2020 is presented. The first column is the country name and the following columns are the overall SPI overall score, and then the sub-scores for pillars 1,2,3,4 and 5.

The purpose of the SPI is to help countries assess and improve the performance of their statistical systems. The presentation of SPI overall scores is designed to reflect that aim. Small differences between countries should not be highlighted since they are likely to reflect imprecision arising from the methodology rather than meaningful differences in performance. Instead, presentation of overall SPI scores focuses on larger groupings of countries reflecting broad categories of performance as measured by the indicator framework.

Countries shaded in dark orange are the lowest performing, countries in dark green are the highest performing. Countries are grouped into five groups:
 

* **Top Quintile**:  Countries in the Top quintile are classified in this group.  Shading in <span style="color:#2ec4b6">dark green</span>.    
* **4th Quintile**: Countries in the 4th quintile, or those above the 60th percentile but below the 80th percentile are in this group.  Shading in <span style="color:#acece7">light green</span>.    
* **3rd Quintile**: Countries in the 3rd quintile, or those between the 40th and 60th percentile, are classified in this group.  Shading in <span style="color:#f1dc76">yellow</span>.  
* **2nd Quintile**: Countries in the 2nd quintile, or those above the 20th percentile but below the 40th percentile, are in this group.  Shading in <span style="color:#ffbf69">light orange</span>.  
* **Bottom 20%**: Countries in the bottom 20% are classified in this group.  Shading in <span style="color:#ff9f1c">dark orange </span>.  



*Table A.1: SPI overall score in 2020 and Pillar Scores*
```{r tab1, echo=FALSE}


#colors

col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab <- spi_index_df %>%
  filter(date==2020) %>%
  select(country, SPI.INDEX,SPI.INDEX.PIL1,SPI.INDEX.PIL2,SPI.INDEX.PIL3,SPI.INDEX.PIL4,SPI.INDEX.PIL5) %>%
  mutate(across(starts_with("SPI.INDEX"),round,1))

 #calculate the breaks for the color coding
        brks <- quantile(index_tab$SPI.INDEX, probs=c(1,2,3,4)/5,na.rm=T)
        brks <- append(0,brks)
        brks <- append(brks,100)

        brks1 <- quantile(index_tab$SPI.INDEX.PIL1, probs=c(1,2,3,4)/5,na.rm=T)
        brks1 <- append(0,brks1)
        if (max(brks1)<100) brks1 <- append(brks1,100)
        
        brks2 <- quantile(index_tab$SPI.INDEX.PIL2, probs=c(1,2,3,4)/5,na.rm=T)
        brks2 <- append(0,brks2)
        if (max(brks2)<100) brks2 <- append(brks2,100)
        
        brks3 <- quantile(index_tab$SPI.INDEX.PIL3, probs=c(1,2,3,4)/5,na.rm=T)
        brks3 <- append(0,brks3)
        if (max(brks3)<100) brks3 <- append(brks3,100)
        
        brks4 <- quantile(index_tab$SPI.INDEX.PIL4, probs=c(1,2,3,4)/5,na.rm=T)
        brks4 <- append(0,brks4)
        if (max(brks4)<100) brks4 <- append(brks4,100)
        
        brks5 <- quantile(index_tab$SPI.INDEX.PIL5, probs=c(1,2,3,4)/5,na.rm=T)
        brks5 <- append(0,brks5)
        if (max(brks5)<100) brks5 <- append(brks5,100)
        

      #make nice looking
      index_tab <- index_tab %>%
        flextable() %>%
        # add_header_lines('SPI overall score in 2020 and Pillar Scores.') %>%
        set_header_labels(values=list(
                             country="Country",
                             SPI.INDEX="SPI overall score",
                             SPI.INDEX.PIL1="Pillar 1: Data Use",
                             SPI.INDEX.PIL2="Pillar 2: Data Services",
                             SPI.INDEX.PIL3="Pillar 3: Data Products ",
                             SPI.INDEX.PIL4="Pillar 4: Data Sources",
                             SPI.INDEX.PIL5="Pillar 5: Data Infrastructure"
                                         )) %>%
          bg(j = c('SPI.INDEX'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL1'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks1, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL2'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks2, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL3'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks3, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL4'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks4, reverse=TRUE)) %>%
          bg(j = c('SPI.INDEX.PIL5'),
             bg = scales::col_bin(col_palette, domain=c(0,100), bins=brks5, reverse=TRUE))
# 
# #make nice looking
# index_tab <- index_tab %>%
#   flextable() %>%
#   add_header_lines('SPI overall score in 2020 and pillar Scores.') %>%
#   set_header_labels(values=list(
#                        country="Country", 
#                        SPI.INDEX="SPI overall score",
#                        SPI.INDEX.PIL1="Dim 1: Data Use",
#                        SPI.INDEX.PIL2="Dim 2: Data Services",
#                        SPI.INDEX.PIL3="Dim 3: Data Products ",
#                        SPI.INDEX.PIL4="Dim 4: Data Sources",
#                        SPI.INDEX.PIL5="Dim 5: Data Infrastructure"
#                                    )) %>%
#     bg(j = c('SPI.INDEX'), 
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL1'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL2'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL3'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL4'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.PIL5'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE))
# 
#   

FitFlextableToPage(index_tab)

```
## Country SPI overall scores over time

*Table A.2: SPI overall scores over time*
```{r tabtime, echo=FALSE}


#colors
col_palette <- c("#2ec4b6", "#acece7", "#f1dc76",  "#ffbf69","#ff9f1c"   )

col_palette2 <- c("#2ec4b6",  "#f1dc76", "#ff9f1c" )

#make the table
index_tab_time <- spi_index_df %>%
  select(country, date, SPI.INDEX) %>%
  mutate(SPI.INDEX=round(SPI.INDEX,1)) %>%
  filter(!is.na(SPI.INDEX)) %>%
  pivot_wider(
    names_from=date,
    values_from=SPI.INDEX,
    names_prefix='SPI.INDEX.'
  )

#make nice looking
index_tab_time <- index_tab_time %>%
  flextable() %>%
  #add_header_lines('SPI overall scores over time') %>%
  set_header_labels(values=list(
                       country="Country", 
                       SPI.INDEX.2020="2020",
                       SPI.INDEX.2019="2019",
                       SPI.INDEX.2018="2018",
                       SPI.INDEX.2017="2017",
                       SPI.INDEX.2016="2016"
                                   )) 
# %>%
#     bg(j = c('SPI.INDEX.2020'), 
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%  
#     bg(j = c('SPI.INDEX.2019'), 
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.2018'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.2017'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) %>%
#     bg(j = c('SPI.INDEX.2016'),
#        bg = scales::col_quantile(col_palette, domain=NULL, n=5, reverse=TRUE)) 

  

FitFlextableToPage(index_tab_time)

```


