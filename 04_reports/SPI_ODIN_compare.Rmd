---
title: "SPI ODIN Comparison"
author: "SPI Team"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2: 
    toc: yes
    fig_width: 9
    fig_height: 6
    number_sections: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 6, fig.cap = "")
library(tidyverse)
library(flextable)
library(here)
# devtools::install_github("worldbank/wbgviz", subdir = "wbgdata")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgcharts")
# devtools::install_github("worldbank/wbgviz", subdir = "wbggeo")
# devtools::install_github("worldbank/wbgviz", subdir = "wbgmaps")
# library(wbggeo)
# library(wbgmaps)
library(ggthemes)
library(Hmisc)
library(httr)
library(patchwork)
library(ggrepel)
library(haven)
library(zoo)
library(estimatr)
library(ggpmisc)
library(ggthemes)
library(ggtext)
library(modelsummary)


#set directories
dir <- here()
raw_dir <- paste(dir, '01_raw_data', sep="/")
output_dir <- paste(dir, '03_output_data', sep="/")
#weights (either unity (1) or population)
wgt <- 1
```


```{r load, include=FALSE}
#add in population
pop_df <- wbstats::wb_data(country="all",
             indicator='SP.POP.TOTL',
             start_date=2004,
             end_date=2020) %>%
  mutate(date=as.numeric(date)) %>%
  mutate(population=SP.POP.TOTL) %>%
  select(country, date, population) 
#import data
spi_index_df <- read_csv(paste(output_dir, 'SPI_index.csv', sep="/")) %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.
#read in the SPI dataset
spi_df_final <- read_csv( file = paste(output_dir, 'SPI_data.csv', sep="/")) %>%
  left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.
#metadata 
metadata <- data.frame(
  series = c('SPI.INDEX', 'SPI.INDEX.PIL1', 'SPI.INDEX.PIL2', 'SPI.INDEX.PIL3', 'SPI.INDEX.PIL4', 'SPI.INDEX.PIL5'),
  indicator_name = c('SPI Overall Score', 'Pillar 1: Data Use', 'Pillar 2: Data Services', 'Pillar 3: Data Products', 'Pillar 4: Data Sources', 'Pillar 5: Data Infrastructure')
)
#get list of country info
country_list <- wbstats::wb_countries()

SPI_WDI <- read_csv('https://raw.githubusercontent.com/worldbank/SPI/master/03_output_data/SPI_index.csv') %>%
    left_join(pop_df) %>%
  mutate(weights=wgt)  #create a variable for weights for estimates.  This just makes is easier to switch between weights and unweighted estimates.


SPI_2020 <- spi_index_df %>%
  filter(date==2020) %>%
  filter(!is.na(SPI.INDEX) & !is.na(weights)) %>%
  mutate(ISO_A3_EH=iso3c) 


SPI <- SPI_2020 %>%
  bind_rows(SPI_WDI)

spi_index_df <- SPI

```

```{r spi_map, echo=FALSE, message=FALSE, warning=FALSE, fig.height=14, fig.width=14}
#ggplot theme
theme_spi <- function () { 
    theme_bw() %+replace%
    theme(
      plot.caption = element_text(hjust = 0),
      plot.title=element_blank() #remove all titles from plots (sometimes we may need to bring title outside plot)
    )
}
#For mapping the result
# quality = "high"
# maps <- wbgmaps::wbgmaps[[quality]]
#load world bank map data
load(paste0(raw_dir, '/misc/maps.Rdata'))
standard_crop_wintri <- function() {
  l <- list(
    left=-12000000, right=16396891,
    top=9400000, bottom=-6500000
  )
  l$xlim <- c(l$left, l$right)
  l$ylim <- c(l$bottom, l$top)
  l
}
country_metadata <- wbstats::wbcountries()
data = SPI
spi_mapper <- function(data, indicator, title) {
  
 indicator<-indicator
   map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(iso3c, date, data_available, weights) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))     
  spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p1<-ggplot() +
    geom_map(data = SPI_map, aes(map_id = iso3c, fill = spi_groups), map = maps$countries) + 
    geom_polygon(data = maps$disputed, aes(long, lat, group = group, map_id = id), fill = "grey80") + 
    geom_polygon(data = maps$lakes, aes(long, lat, group = group), fill = "white")  +
    geom_path(data = maps$boundaries,
              aes(long, lat, group = group),
              color = "white",
              size = 0.4,
              lineend = maps$boundaries$lineend,
              linetype = maps$boundaries$linetype) +
    scale_x_continuous(expand = c(0, 0), limits = standard_crop_wintri()$xlim) +
    scale_y_continuous(expand = c(0, 0), limits = standard_crop_wintri()$ylim) +
    scale_fill_manual(
      name='SPI Score',
      values=col_pal,
      na.value='grey'
    ) +
    coord_equal() +
    theme_map(base_size=12) +
    labs(
      title=str_wrap(title,100),
      caption = 'Source: World Bank. Statistical Performance Indicators'
    ) +
    theme(
      text=element_text(size=14)
    )
 print(p1)
}
spi_charts  <- function(data, indicator, title) {
  
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  #add histogram by region 
  p2 <- map_df %>%
    group_by(region) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=region, fill=region)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Region', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
    theme(
      text=element_text(size=14)
    )
  
  #by income
    income <- c("Low income", "Lower middle income","Upper middle income","High income")
    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights=weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
    theme(
      text=element_text(size=14)
    )
    
  # #add line graph over time
  p4 <- get(data)  %>%
    rename(data_available=!! indicator) %>%
    # right_join(spi_df_empty) %>%
    group_by( date) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available))) %>%
    mutate(`SPI Score`=mean(data_available, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ungroup() %>%
    ggplot(aes(y=`SPI Score`, x=date)) +
      geom_point() +
      geom_line(fill='blue') +
      # geom_text_repel(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Date', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.'
      ) +
    
      expand_limits(y=c(0,100)) +
      theme_spi() +
    theme(
      text=element_text(size=14)
    )
      
 (p2 / p3) 
    
}
spi_country_charts  <- function(data, indicator, title) {
  
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    filter(region!="Aggregates") %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
   spi_groups_quantiles <- quantile(map_df$data_available, probs=c(1,2,3,4)/5,na.rm=T)
  
  SPI_map <- map_df %>%
    mutate(spi_groups=case_when(
      between(data_available, spi_groups_quantiles[4],100) ~ "Top 20%",
      between(data_available, spi_groups_quantiles[3],spi_groups_quantiles[4]) ~ "4th Quintile",
      between(data_available, spi_groups_quantiles[2],spi_groups_quantiles[3]) ~ "3rd Quintile",
      between(data_available, spi_groups_quantiles[1],spi_groups_quantiles[2]) ~ "2nd Quintile",
      between(data_available, 0,spi_groups_quantiles[1]) ~ "Bottom 20%"
      
    )) %>%
    mutate(spi_groups=factor(spi_groups, 
                             levels=c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )))  
  
  #set color pallete
  col_pal <- c("#2ec4b6","#acece7","#f1dc76","#ffbf69","#ff9f1c")  
  names(col_pal) <- c("Top 20%","4th Quintile","3rd Quintile","2nd Quintile","Bottom 20%" )
  
  p2_alt <- SPI_map %>%
    ungroup() %>%
    ggplot(aes(x=data_available, y=region, color=spi_groups)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Country', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      xlab('Score') +
      expand_limits(x=c(0,100)) +
      scale_color_manual(
        name='SPI Score',
        values=col_pal,
        na.value='grey'
      ) +
      theme_spi() +
      theme(legend.position = 'top',
            text=element_text(size=14)
            ) 
p2_alt
}
income_charts <- function(data, indicator, title) { 
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  income <- c("Low income", "Lower middle income","Upper middle income","High income")
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=income, color=income)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            text=element_text(size=14) )
   
p2_alt3 
  
 
}
spi_income_aggregates <- function(data, indicator, title) {
   indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))   
  
    income <- c("Low income", "Lower middle income","Upper middle income","High income")
    p3 <- map_df %>%
    group_by(income) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights=weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=income, fill=income)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Income', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = income) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
    theme(
      text=element_text(size=14)
    )
    
    p3
}
lending_charts <- function(data, indicator, title) { 
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  p2_alt3 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending, color=lending)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            text=element_text(size=14) )
   
p2_alt3 
  
 
}
lending_chart_aggregate <- function(data, indicator, title) { 
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  lending_list <- c("Not classified", "IBRD", "Blend", "IDA" )
  
  
  p2_alt3 <- map_df %>%
    group_by(lending) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=lending, fill=lending)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Lending Status', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = lending_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            text=element_text(size=14) )
   
p2_alt3 
  
 
}
fcs_charts <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")
  p2_alt2 <- map_df %>%
    ungroup() %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=(data_available),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, color=fcs)) +
      geom_point() +
      geom_text(aes(label=country), position=position_jitter(width=.1,height=.4), check_overlap=T) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            text=element_text(size=14)) 
   
p2_alt2 
  
 
}
fcs_chart_aggregate <- function(data, indicator, title) { 
  #FY21 Fragile and conflict-affected situations (http://pubdocs.worldbank.org/en/888211594267968803/FCSList-FY21.pdf)
  high_intensity_conflict <- c('Afghanistan', 'Libya', 'Somalia', 'Syrian Arab Republic' )
  
  medium_intensity_conflict <- c('Burkina Faso', 'Cameroon','Central African Republic', 'Chad', 'Congo, Dem. Rep.',
                                 'Iraq','Mali','Mozambique','Myanmar','Niger','Nigeria','South Sudan','Yemen, Rep.')
  
  high_institutional_social_fragility <- c('Burundi','Congo, Rep.','Eritrea','Gambia, The','Guinea-Bissau',
                                           'Haiti','Kosovo','Lao PDR','Lebanon','Liberia','Papua New Guinea',
                                           'Sudan','Venezuela, RB','West Bank and Gaza','Zimbabwe')
  
  small_states <- c('Comoros','Kiribati','Marshall Islands','Micronesia, Fed. Sts.','Solomon Islands','Timor-Leste','Tuvalu')
  
 indicator<-indicator
  map_df <- get(data) %>%
    filter(date==max(date, na.rm=T)) %>%
    filter(!(country %in% c('Greenland'))) %>% #drop a few countries for which we do not collect data.
    mutate(fcs=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "FCS country",
      country %in% medium_intensity_conflict ~ "FCS country",
      country %in% high_institutional_social_fragility ~ "FCS country",
      country %in% small_states ~ "FCS country",
      TRUE ~ "Non-FCS country"
    )) %>%
    mutate(fcs_detail=case_when( #create indicators for Fragile and Conflict-affected Situations
      country %in% high_intensity_conflict ~ "High-Intensity Conflict",
      country %in% medium_intensity_conflict ~ "Medium-Intensity Conflict",
      country %in% high_institutional_social_fragility ~ "High Institutional & Social Fragility",
      country %in% small_states ~ "Small States",
      TRUE ~ "Non-FCS country"
    )) %>%
    group_by( country) %>%
    #summarise(across(!! indicator,last)) %>%
    rename(data_available=!! indicator) %>%
    select(country,fcs,fcs_detail, date, data_available, weights ) %>%
    right_join(country_metadata) %>%
    mutate(data_available=if_else(is.na(data_available), as.numeric(NA), as.numeric(data_available)))    
  
  fcs_list <- c("High-Intensity Conflict", "Medium-Intensity Conflict","High Institutional & Social Fragility","Small States","Non-FCS country")
  fcs_list <- c("FCS country","Non-FCS country")
  p2_alt2 <- map_df %>%
    group_by(fcs) %>%
    filter(region!='Aggregates') %>%
    mutate(`SPI Score`=wtd.mean(data_available, weights = weights, na.rm=T),
           Label = paste(round(`SPI Score`,0))) %>%
    ggplot(aes(x=`SPI Score`, y=fcs, fill=fcs)) +
      geom_bar(stat="identity",position='dodge') +
      geom_text(aes(label=Label)) +
      labs(
      title=str_wrap(paste(title, 'By Fragile and Conflict-affected Situations (FCS)', sep=" - "),100),
      caption = 'Source: World Bank. Statistical Performance Indicators.',
      subtitle= 'Based on data for 2019 or the latest year available'
      ) +
      scale_y_discrete(limits = fcs_list) +
      expand_limits(x=c(0,100)) +
      theme_spi() +
      theme(legend.position = 'top',
            text=element_text(size=14)) 
  
  
  
p2_alt2 
  
 
}
FitFlextableToPage <- function(ft, pgwidth = 6){
  ft_out <- ft %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}
#add equations to plots
eq_plot_txt <- function(data, inp, var) {
  eq <- lm_robust(inp ~ var, data=data, se_type='HC2')
  coef <- coef(eq)
  std_err <- sqrt(diag(vcov(eq)))
  r_2<- summary(eq)$r.squared
  sprintf("y = %.3f + %.3f x, R<sup>2</sup> = %.3f <br>    (%.3f)   (%.3f)", coef[1], coef[2], r_2[1], std_err[1], std_err[2])

}
```


## Comparison to other measures of statistical performance

```{r spi_df_empty}

# This block of code will create a blank SPI dataset (only containing country info) that will be appended to when each indicator is added.
# There will be two indicators added for each pillar
# 1. An indicator with a score between 0-1 for each pillar
# 2. An indicator with the raw (unscored) values of the indicators
# The unit for this database will be country*year

span <- c(2004:2020)

spi_df_empty <- bind_rows(replicate(length(span), wbstats::wbcountries(), simplify = FALSE), .id='date') %>%
  mutate(date=as.numeric(date)+span[1]-1) %>%
  filter(region!="Aggregates") # take out the aggregates (LAC, SAR, etc)

spi_df <- spi_df_empty

#read list of iso3c codes for matching from UN (https://unstats.un.org/unsd/methodology/m49/)
iso3c <- read_csv(paste(raw_dir,'metadata/iso_codes.csv', sep="/"),
                  col_types=list(col_character(), col_character(), col_character()))

```


```{r comparison, include=FALSE}

#pull SCI values

Request_metadata <- GET(url = "http://api.worldbank.org/v2/country/all/indicator/IQ.SCI.OVRL?format=json&date=2004:2020&per_page=5000")
Response_metadata <- content(Request_metadata, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
sci_df <- jsonlite::fromJSON(Response_metadata, flatten = TRUE) %>%
  data.frame() %>%
  transmute(
    iso3c=countryiso3code,
    country=country.value,
    date=as.numeric(date),
    SCI=value
  ) %>%
  left_join(spi_df_empty) %>% #add on country metadata
  filter(!is.na(income)) %>%
  select(iso3c, country, date, SCI  ) %>%
  group_by(date) %>%
  arrange(-SCI) %>%
  mutate(SCI_rank=rank(-SCI),
         SCI_rank=if_else(is.na(SCI),as.numeric(NA),SCI_rank))


#check unique values by dimension.
unique_scores_df <- sci_df %>% filter(date==2019) %>% mutate(SCI=round(SCI,3))
unique_scores_sci <-length(unique(unique_scores_df$SCI))



#read in ODIN data
  for (i in c(2015, 2016, 2017, 2018, 2020)) {
   temp <- read_csv(paste(raw_dir, '/2.2_DSOA/','ODIN_',i,'.csv', sep=""))  %>%
        as_tibble(.name_repair = 'universal') %>%
        mutate(date=i,
               Year=as.numeric(Year)) %>%
          
        filter(Data.categories=='All Categories')


    assign(paste('odin_df',i,sep="_"), temp)
  }

    #bind different years together
odin_df <- bind_rows(odin_df_2015, odin_df_2016, odin_df_2017, odin_df_2018, odin_df_2020)


odin_df <- odin_df %>%
    select(Country.Code, date, Overall.score) %>%
    rename(iso3c=Country.Code,
           ODIN_score=Overall.score) %>%
    group_by(date) %>%
    arrange(-ODIN_score) %>%
    mutate(ODIN_rank=rank(-ODIN_score, na.last='NA')) %>% 
  right_join(spi_df_empty) %>%
  arrange(country, date) %>%
  group_by(country) %>%
  mutate(across(starts_with("ODIN"), na.locf, na.rm=FALSE)) %>%
  select(country, date, starts_with("ODIN"))


##add in gdp
gdp_df <- wbstats::wb_data(country="all",
             indicator=c('NY.GDP.PCAP.PP.KD', "GE.EST"),
             start_date=2004,
             end_date=2020) %>%
  mutate(date=as.numeric(date)) 

#poverty
pov_df <- wbstats::wb_data(country="countries_only", 
              indicator=c('SI.POV.DDAY', "HD.HCI.OVRL","SI.POV.GINI"),
              start_date=2004,
              end_date=2020,
              mrv=10,
              gapfill=TRUE,
              return_wide = T)

#read in the old SPI
SPI_v0_df <- readxl::read_excel(path='C:/Users/wb469649/OneDrive - WBG/DECIS/SPI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx', skip=2) %>%
  transmute(
    iso3c=Country,
    SPI_2016=as.numeric(Overall...7),
    SPI_2017=as.numeric(Overall...12),
    SPI_2018=as.numeric(Overall...17)
  ) %>%
  pivot_longer(
    cols=c('SPI_2016','SPI_2017','SPI_2018'),
    names_to="date",
    values_to = 'SPI_v0'
  ) %>%
  mutate(date=gsub('SPI_','',date),
         date=as.numeric(date))


#create one database
comparison_df <- spi_index_df %>%
  ungroup() %>%
  filter(date %in% c(2016:2020)) %>%
  arrange(-SPI.INDEX) %>%
  mutate(across(starts_with('SPI.INDEX'),~1*.),
         across(starts_with('SPI.INDEX'),round,1)) %>%
  select(country, iso3c, date, income, region, SPI.INDEX) %>%
  left_join(sci_df) %>%
  left_join(odin_df) %>%
  left_join(SPI_v0_df) %>%
  left_join(gdp_df) %>%
  left_join(pov_df)




```

We compare the SPI overall score to the [Open Data Watch rankings of country statistical systems](https://odin.opendatawatch.com/report/rankings).  The correlation between the SPI overall score and the ODIN index is `r round(cor(comparison_df$SPI.INDEX,comparison_df$ODIN_score, use='pairwise.complete.obs'),3)`
 


```{r odin, echo=FALSE}

 

### Scatterplot ODIN SPI
spi_odin_plot <- ggplot(comparison_df, aes(y=SPI.INDEX,x=ODIN_score, color=region)) +
  # geom_point() +
  facet_wrap(~date) +
  geom_text(aes(label=iso3c)) +
  theme_spi() +
  labs(
    title='Scatterplot of SPI overall score on Open Data Watch Index'
  ) +
  ylab('SPI overall score') +
  xlab('ODIN value') +
  theme(legend.position = 'bottom')

spi_odin_plot





```

```{r odin_gdp, echo=FALSE}

 

### Scatterplot ODIN SPI
odin_gdp_plot <- ggplot((comparison_df %>% filter(date==2020)), aes(y=ODIN_score,x=NY.GDP.PCAP.PP.KD, color=region)) +
  # geom_point() +
  facet_wrap(~date) +
  geom_text(aes(label=iso3c)) +
  scale_x_log10(labels=scales::comma) +
  theme_spi() +
  labs(
    title='Scatterplot of Open Data Watch Index on GDP per capita, PPP (constant 2017 international $)'
  ) +
  ylab('ODIN value') +
  xlab('GDP per capita, PPP (constant 2017 international $)') +
  theme(legend.position = 'bottom')

odin_gdp_plot

lm(ODIN_score ~ log10(NY.GDP.PCAP.PP.KD), data=(comparison_df %>% filter(date==2020))) %>% summary()

### Scatterplot ODIN SPI
spi_gdp_plot <- ggplot((comparison_df %>% filter(date==2020)), aes(y=SPI.INDEX,x=NY.GDP.PCAP.PP.KD, color=region)) +
  # geom_point() +
  facet_wrap(~date) +
  geom_text(aes(label=iso3c)) +
  scale_x_log10(labels=scales::comma) +
  theme_spi() +
  labs(
    title='Scatterplot of Open Data Watch Index on GDP per capita, PPP (constant 2017 international $)'
  ) +
  ylab('SPI overall score') +
  xlab('GDP per capita, PPP (constant 2017 international $)') +
  theme(legend.position = 'bottom')

spi_gdp_plot

lm(SPI.INDEX ~ log10(NY.GDP.PCAP.PP.KD), data=(comparison_df %>% filter(date==2020))) %>% summary()


```

```{r}


#create regression models
 models <- list(


 'ODIN' = lm_robust(ODIN_score ~  log10(NY.GDP.PCAP.PP.KD) , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,

 'SPI' = lm_robust(SPI.INDEX ~  log10(NY.GDP.PCAP.PP.KD)    , data=(comparison_df %>% filter(date==2020)), se_type='HC2'), 
   
 'ODIN' = lm_robust(ODIN_score ~  SI.POV.DDAY , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,

 'SPI' = lm_robust(SPI.INDEX ~  SI.POV.DDAY   , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,
 
  'ODIN' = lm_robust(ODIN_score ~  SI.POV.GINI , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,

 'SPI' = lm_robust(SPI.INDEX ~  SI.POV.GINI   , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,
 
  'ODIN' = lm_robust(ODIN_score ~  HD.HCI.OVRL , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,

 'SPI' = lm_robust(SPI.INDEX ~  HD.HCI.OVRL    , data=(comparison_df %>% filter(date==2020)), se_type='HC2'), 
   
 'ODIN' = lm_robust(ODIN_score ~  GE.EST , data=(comparison_df %>% filter(date==2020)), se_type='HC2') ,

 'SPI' = lm_robust(SPI.INDEX ~  GE.EST   , data=(comparison_df %>% filter(date==2020)), se_type='HC2')   
 

 )


 modelsummary(models,
              estimate= "{estimate}{stars}",
              #vcov=list(NULL,"HC1",NULL),
              coef_rename = c("SPI.INDEX"  = "SPI Overall Score",
                              "ODIN_score" = "ODIN",
                              "SI.POV.DDAY" = "$1.90 Poverty Headcount Ratio",
                              "SI.POV.GINI" = "Gini Index",
                              "SPI.INDEX.PIL1"  = "SPI Pillar 1 Score",
                              "SPI.INDEX.PIL2"  = "SPI Pillar 2 Score",
                              "SPI.INDEX.PIL3"  = "SPI Pillar 3 Score",
                              "SPI.INDEX.PIL4"  = "SPI Pillar 4 Score",
                              "SPI.INDEX.PIL5"  = "SPI Pillar 5 Score",
                              "log10(NY.GDP.PCAP.PP.KD)"= "Log GDP per capita",
                              "log(lag_outcome)" = "Log lagged GDP per capita" ,
                              "lag(log(NY.GDP.PCAP.KD), 1)" = "Log lagged GDP per capita" ,
                              "NV.IND.MANF.ZS"  = "Manufacturing value added (% of GDP)",
                              "NV.AGR.TOTL.ZS"= "Agriculture, forestry, fishing value added (% of GDP)",
                              "BN.CAB.XOKA.GD.ZS"= "Current account balance (% of GDP)",
                              "HD.HCI.OVRL" = "Human Capital Index (0-1 scale)",
                              "SE.PRM.ENRR" = "School Enrollment, Primary (% gross)" ,
                              "NE.TRD.GNFS.ZS" = "Trade (% of GDP)",
                              "WGI.OVL" = "WGI Index",
                              "CC.EST" = "WGI: Control of Corruption: Estimate",
                              "GE.EST" = "WGI: Governance Effectiveness: Estimate",
                              "PV.EST" = "WGI: Political Stability and Absence of Violence/Terrorism: Estimate",
                              "RQ.EST" = "WGI: Regulatory Quality: Estimate",
                              "RL.EST" = "WGI: Rule of Law: Estimate",
                              "VA.EST" = "WGI: Voice and Accountability: Estimate"),
              notes="Data from the World Bank's World Development Indicators (WDI) and ODIN website.Data for year 2020. 
              ***=0.001 level
              **=0.01 level
              *=0.05 level
              +=0.1 level",
              escape = FALSE
              )
```


Below we show a selection of 30 countries, where we calculate the countries with the largest changes in country rankings between ODIN and the SPI overall score.  Differences in country rankings are compared, rather than scores, because even though the SPI and ODIN overall scores are both on a 0-100 scale, they measures are not directly comparable.  Data is for 2020, since this is the latest year available with both an ODIN and SPI overall score.  Countries shaded in green have a higher ranking in the SPI than in ODIN.  Taking Chile for an example, ODIN ranks Chile as the 116th best system among the 174 countries, while the SPI ranks Chile as the 36th best system.  ODIN penalizes Chile for not having metadata for the indicators on their NSO website and not having terms of use and data download options.  While it may be the case that the Chile NSO website struggles in this area, Chile scores very highly in data infrastructure, reporting on the SDGs, and on data dissemination standards for the IMF.  

On the other side, a country like Oman is rated as the 26th best system by ODIN and 103rd best system by the SPI.  Oman gets very high openness scores by ODIN.  However, for the SPI, Oman performs below average on data infrastructure compared to high income countries, lacking many of the standards and classifications.  Jamaica is rated as the 36th best system by ODIN and the 113th best by the SPI.  Jamaice scores poorly on data infrastructure by the SPI.  

```{r overperformers}

#get top 10 and bottom 10 over performers compared to odin 

odin_overperformers_df_full <- comparison_df %>%
  filter(date==2020) %>%
  filter(!is.na(SPI.INDEX)) %>%
  filter(!is.na(ODIN_score)) %>%
  mutate(
    SPI_ranked = rank(-SPI.INDEX),
     ODIN_ranked= rank(-ODIN_score),
    resid=ODIN_ranked-SPI_ranked
    ) %>%
  arrange(resid) 

odin_overperformers_df <- odin_overperformers_df_full %>%
  head(15)

odin_underperformers_df <- comparison_df %>%
  filter(date==2020) %>%
  filter(!is.na(SPI.INDEX)) %>%
  filter(!is.na(ODIN_score)) %>%
  mutate(
    SPI_ranked = rank(-SPI.INDEX),
    ODIN_ranked = rank(-ODIN_score),
    resid=ODIN_ranked-SPI_ranked
    ) %>%
  arrange(-resid) %>%
  head(15)


odin_overperformers_plot <-  odin_overperformers_df %>%
  bind_rows(odin_underperformers_df) %>%
  arrange(resid) 

odin_overperformers_plot <- odin_overperformers_plot %>%
  mutate(country=factor(country, levels=unique(odin_overperformers_plot$country)),
         group=if_else(resid>=0, 'above','below')) %>%
  ggplot(aes(x=country, y=resid, color=group)) +
  geom_segment( aes(x=country ,xend=country, y=0, yend=resid), color="black") +
  geom_point(size=3) +
  scale_color_manual(name="Legend",
                     labels = c("Ranked higher in SPI than ODIN", "Ranked Higher in ODIN than SPI"),
                     values = c('above'="#1A9850", 'below'="#D73027")) +
  coord_flip() +
  theme_bw() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.position = 'bottom'
  ) +
  xlab("") +
  ylab("Difference in ODIN Country Rank SPI Country Rank") +
  ggtitle("Difference in Country Ranks Between ODIN and SPI Overall Scores for 2020",
          subtitle = 'Only shows selection of 30 countries with largest gaps')



odin_overperformers_plot  
```
```{r table}

odin_overperformers_df_full %>%
  mutate(difference_ranked=resid) %>%
  select(country, SPI.INDEX, ODIN_score, SPI_ranked, ODIN_ranked, difference_ranked) %>%
  arrange(-SPI.INDEX) %>%
  flextable() %>%
  add_header_lines('SPI and ODIN Country Rankings in 2020')

```

## Comparison of Pillar 3 of SPI and ODIN Coverage Measure

In the following, we will investigate how SPI rankings would change if the SPI pillar 3 is substituted with the ODIN indicator coverage and disaggregation score and the overall coverage subscore.

```{r}
#create version of SPI using the ODIN coverage subscore

spi_odin_combined <- SPI_2020 %>%
  left_join((odin_df_2020 %>% rename(iso3c=Country.Code))) %>%
  left_join(gdp_df) %>%
  mutate(spi_overall_odin_score=(
           SPI.INDEX.PIL1+SPI.INDEX.PIL2+Coverage.subscore+
           SPI.INDEX.PIL4+SPI.INDEX.PIL5)/5)

ggplot(spi_odin_combined, aes(x=SPI.INDEX, y=spi_overall_odin_score)) +
  geom_point() +
  geom_text_repel(aes(label=iso3c)) +
  geom_smooth(method = "lm") +
  geom_richtext(
    aes(x = 30, y = 75,label = eq_plot_txt(spi_odin_combined, SPI.INDEX, spi_overall_odin_score), hjust=0.2)
  ) +
  xlab("SPI Overall Score: 2020") +
  ylab("SPI Overall Score with ODIN Coverage Score: 2020") +
  ggtitle(str_wrap('Comparison of SPI Overall Score in 2020 with Hypothetical SPI Overall Score that uses ODIN coverage score rather than SPI Pillar 3 score',75),
          subtitle = 'All Pillars given equal weight') +
  theme_bw()
  
           

```
```{r}
ggplot(spi_odin_combined, aes(y=SPI.INDEX.PIL3, x=NY.GDP.PCAP.PP.KD)) +
  geom_point() +
  geom_text_repel(aes(label=iso3c)) +
  geom_smooth(method = "lm") +
  scale_x_log10(labels=scales::comma) +
  geom_richtext(
    aes(x = 1000, y = 20,label = eq_plot_txt(spi_odin_combined, SPI.INDEX.PIL3, log10(NY.GDP.PCAP.PP.KD)), hjust=0.2)
  ) +
  xlab("GDP per capita, PPP (constant 2017 $)") +
  ylab("SPI Pillar 3 Score") +
  ggtitle(str_wrap('Comparison of SPI Pillar 3 Score in 2020 to GDP per capita, PPP',75)) +
  theme_bw()
```

```{r}
ggplot(spi_odin_combined, aes(y=Coverage.subscore, x=NY.GDP.PCAP.PP.KD)) +
  geom_point() +
  geom_text_repel(aes(label=iso3c)) +
  geom_smooth(method = "lm") +
  scale_x_log10(labels=scales::comma) +
  geom_richtext(
    aes(x = 1000, y = 20,label = eq_plot_txt(spi_odin_combined, Coverage.subscore, log10(NY.GDP.PCAP.PP.KD)), hjust=0.2)
  ) +
  xlab("GDP per capita, PPP (constant 2017 $)") +
  ylab("ODIN coverage subscore") +
  ggtitle(str_wrap('Comparison of ODIN coverage Score in 2020 to GDP per capita, PPP',75)) +
  theme_bw()
```


```{r}
ggplot(spi_odin_combined, aes(y=SPI.INDEX, x=NY.GDP.PCAP.PP.KD)) +
  geom_point() +
  geom_text_repel(aes(label=iso3c)) +
  geom_smooth(method = "lm") +
  scale_x_log10(labels=scales::comma) +
  geom_richtext(
    aes(x = 1000, y = 20,label = eq_plot_txt(spi_odin_combined, SPI.INDEX, log10(NY.GDP.PCAP.PP.KD)), hjust=0.2)
  ) +
  xlab("GDP per capita, PPP (constant 2017 $)") +
  ylab("SPI Overall Score") +
  ggtitle(str_wrap('Comparison of SPI Overall Score in 2020 to GDP per capita, PPP',75)) +
  theme_bw()
```

```{r}
ggplot(spi_odin_combined, aes(y=spi_overall_odin_score, x=NY.GDP.PCAP.PP.KD)) +
  geom_point() +
  geom_text_repel(aes(label=iso3c)) +
  geom_smooth(method = "lm") +
  scale_x_log10(labels=scales::comma) +
  geom_richtext(
    aes(x = 1000, y = 20,label = eq_plot_txt(spi_odin_combined, spi_overall_odin_score, log10(NY.GDP.PCAP.PP.KD)), hjust=0.2)
  ) +
  xlab("GDP per capita, PPP (constant 2017 $)") +
  ylab("Hypothetical SPI Overall Score that uses ODIN coverage score") +
  ggtitle(str_wrap('Comparison of Hypothetical SPI Overall Score that uses ODIN coverage score in 2020 to GDP per capita, PPP',75)) +
  theme_bw()
```